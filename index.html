<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gráfica de Ingresos, EBITDA, Utilidad Neta, Margen EBITDA y Margen Neto</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }

        h1 {
            text-align: center;
        }

        #controls {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .chip {
            display: inline-block;
            padding: 10px;
            margin: 5px;
            background-color: #ccc; /* Color gris por defecto */
            color: black;
            border-radius: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .chip.selected {
            background-color: #007BFF; /* Color azul al seleccionar */
            color: white;
        }

        .chart-container {
            display: flex;
            flex-direction: column; /* Cambiado a columna */
            align-items: center; /* Centrar gráficos */
            margin-top: 20px;
        }

        canvas {
            width: 900px !important; /* Ancho al 80% del contenedor */
            height: 500px !important; /* Altura fija para los gráficos */
            margin-bottom: 20px; /* Espacio entre gráficos */
        }

        button {
            padding: 10px 15px;
            margin-top: 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Gráfica de Ingresos, EBITDA, Utilidad Neta, Margen EBITDA y Margen Neto</h1>
    
    <div id="controls">
        <h2>Selecciona la Empresa</h2>
        <div id="empresaChips"></div>
        
        <button id="updateChart">Actualizar Gráficas</button>
    </div>

    <div class="chart-container">
        <div>
            <h3>Ingresos</h3>
            <canvas id="ingresosChart"></canvas>
        </div>
        <div>
            <h3>EBITDA</h3>
            <canvas id="ebitdaChart"></canvas>
        </div>
        <div>
            <h3>Utilidad Neta</h3>
            <canvas id="utilidadNetaChart"></canvas>
        </div>
        <div>
            <h3>Margen EBITDA</h3>
            <canvas id="margenEbitdaChart"></canvas>
        </div>
        <div>
            <h3>Margen Neto</h3>
            <canvas id="margenNetoChart"></canvas>
        </div>
    </div>

    <script>
        const url = 'https://raw.githubusercontent.com/ibidco/dashboard/main/datos.json'; // Reemplaza con tu URL
        let datos = [];
        let empresas = [];
        let periodos = [];
        let ingresosChart, ebitdaChart, utilidadNetaChart, margenEbitdaChart, margenNetoChart;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                datos = data.map(item => ({
                    empresa: item.Empresa,
                    periodo: item.Periodo,
                    año: item.Año,
                    id: item.ID,
                    sector: item.Sector,
                    subsector: item.Subsector,
                    ingresos: parseInt(item.Ingresos, 10),
                    costos: parseInt(item.Costos, 10),
                    utilidadBruta: parseInt(item["Utilidad bruta"], 10),
                    ebitda: parseFloat(item.EBITDA) || 0,
                    utilidadNeta: parseInt(item["Utilidad neta"], 10)
                }));

                empresas = [...new Set(datos.map(item => item.empresa))];
                periodos = [...new Set(datos.map(item => item.periodo))];
                renderEmpresaChips();
                updateCharts();
            })
            .catch(error => console.error('Error al cargar los datos:', error));

        function renderEmpresaChips() {
            const container = document.getElementById('empresaChips');
            empresas.forEach(empresa => {
                const chip = document.createElement('div');
                chip.className = 'chip';
                chip.innerText = empresa;
                chip.onclick = () => {
                    chip.classList.toggle('selected');
                };
                container.appendChild(chip);
            });
        }

        function getSelectedEmpresas() {
            const selectedChips = document.querySelectorAll('#empresaChips .chip.selected');
            return Array.from(selectedChips).map(chip => chip.innerText);
        }

        function updateCharts() {
            const selectedEmpresas = getSelectedEmpresas();

            if (selectedEmpresas.length === 0) {
                alert('Por favor, selecciona al menos una empresa.');
                return;
            }

            const ingresosData = [];
            const ebitdaData = [];
            const utilidadNetaData = [];
            const margenEbitdaData = [];
            const margenNetoData = [];

            // Datos por periodo
            periodos.forEach(periodo => {
                const ingresoValues = selectedEmpresas.map(empresa => {
                    const ingreso = datos.find(item => item.periodo === periodo && item.empresa === empresa);
                    return ingreso ? ingreso.ingresos : 0;
                });
                const ebitdaValues = selectedEmpresas.map(empresa => {
                    const ebitda = datos.find(item => item.periodo === periodo && item.empresa === empresa);
                    return ebitda ? ebitda.ebitda : 0;
                });
                const utilidadNetaValues = selectedEmpresas.map(empresa => {
                    const utilidadNeta = datos.find(item => item.periodo === periodo && item.empresa === empresa);
                    return utilidadNeta ? utilidadNeta.utilidadNeta : 0;
                });

                // Calcular Margen EBITDA
                const margenEbitdaValues = selectedEmpresas.map((empresa, index) => {
                    return ingresoValues[index] !== 0 ? (ebitdaValues[index] / ingresoValues[index]) * 100 : 0; // Convertir a porcentaje
                });

                // Calcular Margen Neto
                const margenNetoValues = selectedEmpresas.map((empresa, index) => {
                    return ingresoValues[index] !== 0 ? (utilidadNetaValues[index] / ingresoValues[index]) * 100 : 0; // Convertir a porcentaje
                });

                ingresosData.push(ingresoValues);
                ebitdaData.push(ebitdaValues);
                utilidadNetaData.push(utilidadNetaValues);
                margenEbitdaData.push(margenEbitdaValues);
                margenNetoData.push(margenNetoValues);
            });

            const ctxIngresos = document.getElementById('ingresosChart').getContext('2d');
            const ctxEbitda = document.getElementById('ebitdaChart').getContext('2d');
            const ctxUtilidadNeta = document.getElementById('utilidadNetaChart').getContext('2d');
            const ctxMargenEbitda = document.getElementById('margenEbitdaChart').getContext('2d');
            const ctxMargenNeto = document.getElementById('margenNetoChart').getContext('2d');

            if (ingresosChart) ingresosChart.destroy();
            if (ebitdaChart) ebitdaChart.destroy();
            if (utilidadNetaChart) utilidadNetaChart.destroy();
            if (margenEbitdaChart) margenEbitdaChart.destroy();
            if (margenNetoChart) margenNetoChart.destroy();

            const colorPalette = [
                '#FF5733', // Rojo
                '#33FF57', // Verde
                '#3357FF', // Azul
                '#FF33A1', // Rosa
                '#FFC300', // Amarillo
                '#DAF7A6', // Verde claro
                '#581845', // Púrpura
                '#900C3F', // Burdeos
                '#FFC300', // Amarillo
                '#FF5733'  // Rojo
            ];

            ingresosChart = new Chart(ctxIngresos, {
                type: 'bar',
                data: {
                    labels: periodos,
                    datasets: selectedEmpresas.map((empresa, index) => ({
                        label: empresa,
                        data: ingresosData.map(values => values[index]),
                        backgroundColor: colorPalette[index % colorPalette.length],
                        borderColor: '#000',
                        borderWidth: 1
                    }))
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Ingresos'
                            }
                        }
                    }
                }
            });

            ebitdaChart = new Chart(ctxEbitda, {
                type: 'bar',
                data: {
                    labels: periodos,
                    datasets: selectedEmpresas.map((empresa, index) => ({
                        label: empresa,
                        data: ebitdaData.map(values => values[index]),
                        backgroundColor: colorPalette[index % colorPalette.length],
                        borderColor: '#000',
                        borderWidth: 1
                    }))
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'EBITDA'
                            }
                        }
                    }
                }
            });

            utilidadNetaChart = new Chart(ctxUtilidadNeta, {
                type: 'bar',
                data: {
                    labels: periodos,
                    datasets: selectedEmpresas.map((empresa, index) => ({
                        label: empresa,
                        data: utilidadNetaData.map(values => values[index]),
                        backgroundColor: colorPalette[index % colorPalette.length],
                        borderColor: '#000',
                        borderWidth: 1
                    }))
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Utilidad Neta'
                            }
                        }
                    }
                }
            });

            // Gráfico de Margen EBITDA en líneas
            margenEbitdaChart = new Chart(ctxMargenEbitda, {
                type: 'line',
                data: {
                    labels: periodos,
                    datasets: selectedEmpresas.map((empresa, index) => ({
                        label: empresa,
                        data: margenEbitdaData.map(values => values[index]),
                        backgroundColor: `rgba(${(index + 1) * 50}, 165, 255, 0.5)`,
                        borderColor: colorPalette[index % colorPalette.length],
                        borderWidth: 2,
                        fill: false
                    }))
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Margen EBITDA (%)'
                            }
                        }
                    }
                }
            });

            // Gráfico de Margen Neto
            margenNetoChart = new Chart(ctxMargenNeto, {
                type: 'line',
                data: {
                    labels: periodos,
                    datasets: selectedEmpresas.map((empresa, index) => ({
                        label: empresa,
                        data: margenNetoData.map(values => values[index]),
                        backgroundColor: `rgba(${(index + 1) * 50}, 165, 255, 0.5)`,
                        borderColor: colorPalette[index % colorPalette.length],
                        borderWidth: 2,
                        fill: false
                    }))
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Margen Neto (%)'
                            }
                        }
                    }
                }
            });
        }

        document.getElementById('updateChart').addEventListener('click', updateCharts);
    </script>
</body>
</html>
